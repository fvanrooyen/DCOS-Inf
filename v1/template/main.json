{
   "Metadata":{
      "DcosImageCommit":"fbec5b3732e80f2d5f65192539c49ba5ab9ab753",
      "TemplateGenerationDate":"2016-07-29 10:19:32.666479"
   },
   "Resources":{
      "Infrastructure":{
         "Properties":{
            "TemplateURL":"https://s3-us-west-2.amazonaws.com/dcosor2/inf.json",
            "Parameters":{
               "KeyName":{
                  "Ref":"KeyName"
               },
               "Vpc":{
                  "Ref":"Vpc"
               },
               "PrivateSubnet":{
                  "Ref":"PrivateSubnet"
               },
               "PublicSubnet":{
                  "Ref":"PublicSubnet"
               },
               "InternetGateway":{
                  "Ref":"InternetGateway"
               }
            },
            "TimeoutInMinutes":"60"
         },
         "Type":"AWS::CloudFormation::Stack"
      },
      "PublicAgentStack":{
         "Properties":{
            "TemplateURL":"https://s3-us-west-2.amazonaws.com/dcosor2/pubagent.json",
            "Parameters":{
               "KeyName":{
                  "Ref":"KeyName"
               },
               "PublicAgentInstanceType":{
                  "Ref":"PublicAgentInstanceType"
               },
               "PublicAgentInstanceCount":{
                  "Ref":"PublicAgentInstanceCount"
               },
               "InternalMasterLoadBalancerDnsName":{
                  "Fn::GetAtt":[
                     "MasterStack",
                     "Outputs.InternalMasterLoadBalancerDnsName"
                  ]
               },
               "PublicSubnet":{
                  "Ref":"PublicSubnet"
               },
               "PublicAgentSecurityGroup":{
                  "Fn::GetAtt":[
                     "Infrastructure",
                     "Outputs.PublicAgentSecurityGroupId"
                  ]
               }
            },
            "TimeoutInMinutes":"60"
         },
         "Type":"AWS::CloudFormation::Stack",
         "DependsOn":[
            "Infrastructure",
            "MasterStack"
         ]
      },
      "PrivateAgentStack":{
         "Properties":{
            "TemplateURL":"https://s3-us-west-2.amazonaws.com/dcosor2/privagent.json",
            "Parameters":{
               "KeyName":{
                  "Ref":"KeyName"
               },
               "PrivateAgentSecurityGroup":{
                  "Fn::GetAtt":[
                     "Infrastructure",
                     "Outputs.PrivateAgentSecurityGroupId"
                  ]
               },
               "PrivateSubnet":{
                  "Ref":"PrivateSubnet"
               },
               "PrivateAgentInstanceCount":{
                  "Ref":"PrivateAgentInstanceCount"
               },
               "InternalMasterLoadBalancerDnsName":{
                  "Fn::GetAtt":[
                     "MasterStack",
                     "Outputs.InternalMasterLoadBalancerDnsName"
                  ]
               },
               "PrivateAgentInstanceType":{
                  "Ref":"PrivateAgentInstanceType"
               }
            },
            "TimeoutInMinutes":"60"
         },
         "Type":"AWS::CloudFormation::Stack",
         "DependsOn":[
            "Infrastructure",
            "MasterStack"
         ]
      },
      "MasterStack":{
         "Properties":{
            "TemplateURL":"https://s3-us-west-2.amazonaws.com/dcosor2/master.json",
            "Parameters":{
               "KeyName":{
                  "Ref":"KeyName"
               },
               "PrivateAgentSecurityGroup":{
                  "Fn::GetAtt":[
                     "Infrastructure",
                     "Outputs.PrivateAgentSecurityGroupId"
                  ]
               },
               "PrivateSubnet":{
                  "Ref":"PrivateSubnet"
               },
               "AcceptEULA":{
                  "Ref":"AcceptEULA"
               },
               "LbSecurityGroup":{
                  "Fn::GetAtt":[
                     "Infrastructure",
                     "Outputs.LbSecurityGroupId"
                  ]
               },
               "ExhibitorS3Bucket":{
                  "Fn::GetAtt":[
                     "Infrastructure",
                     "Outputs.ExhibitorS3BucketId"
                  ]
               },
               "AdminSecurityGroup":{
                  "Fn::GetAtt":[
                     "Infrastructure",
                     "Outputs.AdminSecurityGroupId"
                  ]
               },
               "PublicSubnet":{
                  "Ref":"PublicSubnet"
               },
               "MasterSecurityGroup":{
                  "Fn::GetAtt":[
                     "Infrastructure",
                     "Outputs.MasterSecurityGroupId"
                  ]
               },
               "PublicAgentSecurityGroup":{
                  "Fn::GetAtt":[
                     "Infrastructure",
                     "Outputs.PublicAgentSecurityGroupId"
                  ]
               },
               "MasterInstanceType":{
                  "Ref":"MasterInstanceType"
               }
            },
            "TimeoutInMinutes":"60"
         },
         "Type":"AWS::CloudFormation::Stack",
         "DependsOn":[
            "Infrastructure"
         ]
      }
   },
   "Parameters":{
      "KeyName":{
         "Type":"AWS::EC2::KeyPair::KeyName",
         "Description":"\nSpecify your AWS EC2 Key Pair."
      },
      "Vpc":{
         "Type":"AWS::EC2::VPC::Id",
         "Description":"\nExisting VPC to use. Nodes will be launched using subnets and Internet Gateway under this VPC"
      },
      "PrivateSubnet":{
         "Type":"AWS::EC2::Subnet::Id",
         "Description":"\nSubnet ID for use by all private agent nodes"
      },
      "AcceptEULA":{
         "Type":"String",
         "Description":"\nRead the Mesosphere EULA and indicate agreement: https://docs.mesosphere.com/community-edition-eula/.",
         "AllowedValues":[
            "Yes"
         ]
      },
      "PrivateAgentInstanceCount":{
         "Type":"Number",
         "Description":"\nSpecify the number of private agent nodes or accept the default.",
         "Default":"5"
      },
      "PublicAgentInstanceCount":{
         "Type":"Number",
         "Description":"\nSpecify the number of public agent nodes or accept the default.",
         "Default":"5"
      },
      "PublicAgentInstanceType":{
         "Type":"String",
         "Description":"\nRegion-specific instance type. E.g. m3.xlarge",
         "Default":"m3.xlarge"
      },
      "PublicSubnet":{
         "Type":"AWS::EC2::Subnet::Id",
         "Description":"\nSubnet ID for use by all public agent nodes"
      },
      "PrivateAgentInstanceType":{
         "Type":"String",
         "Description":"\nRegion-specific instance type. E.g. m3.xlarge",
         "Default":"m3.xlarge"
      },
      "InternetGateway":{
         "Type":"String",
         "Description":"\nInternet Gateway ID, must be attached to the 'Vpc'. Used by all nodes for outgoing Internet access."
      },
      "MasterInstanceType":{
         "Type":"String",
         "Description":"\nRegion-specific instance type. E.g. m3.xlarge",
         "Default":"m3.xlarge"
      }
   },
   "AWSTemplateFormatVersion":"2010-09-09",
   "Outputs":{
      "StackRef":{
         "Value":{
            "Ref":"MasterStack"
         }
      },
      "OutputFromNestedStack":{
         "Value":{
            "Fn::GetAtt":[
               "MasterStack",
               "Outputs.MasterDNSName"
            ]
         }
      }
   }
}